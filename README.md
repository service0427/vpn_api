# VPN Key Pool Management API

μ¤‘μ•™ μ§‘μ¤‘μ‹ VPN ν‚¤ ν’€ κ΄€λ¦¬ μ‹μ¤ν…μ…λ‹λ‹¤. μ—¬λ¬ VPN μ„λ²„μ WireGuard ν‚¤λ¥Ό μ¤‘μ•™μ—μ„ κ΄€λ¦¬ν•κ³ , ν΄λΌμ΄μ–ΈνΈκ°€ μλ™μΌλ΅ ν‚¤λ¥Ό ν• λ‹Ήλ°›κ³  λ°λ‚©ν•  μ μμµλ‹λ‹¤.

---

## μ‹μ¤ν… μ •λ³΄

- **API URL**: http://220.121.120.83/vpn_api
- **ν”λ«νΌ**: Apache 2.4.62 + PHP 8.4.13 (Rocky Linux)
- **λ°μ΄ν„°λ² μ΄μ¤**: MariaDB
- **ν”„λ΅ν† μ½**: WireGuard

---

## λ¬Έμ„

### μ‚¬μ©μλ³„ κ°€μ΄λ“

| λ€μƒ | λ¬Έμ„ | μ„¤λ… |
|------|------|------|
| **VPN μ‚¬μ©μ** | [CLIENT_API.md](CLIENT_API.md) | VPN ν‚¤ ν• λ‹Ή/λ°λ‚© λ°©λ²• |
| **μ„λ²„ κ΄€λ¦¬μ** | [SERVER_ADMIN.md](SERVER_ADMIN.md) | VPN μ„λ²„ λ“±λ΅ λ° κ΄€λ¦¬ |
| **κ°λ°μ** | [CLAUDE.md](CLAUDE.md) | μ½”λ“λ² μ΄μ¤ μ•„ν‚¤ν…μ² λ° κ°λ° κ°€μ΄λ“ |

---

## λΉ λ¥Έ μ‹μ‘

### VPN μ‚¬μ©μ (ν‚¤ ν• λ‹Ήλ°›κΈ°)

```bash
# 1. VPN ν‚¤ ν• λ‹Ή
curl "http://220.121.120.83/vpn_api/allocate"

# 2. μ‘λ‹µμ—μ„ config λ‚΄μ©μ„ WireGuard μ„¤μ •μΌλ΅ μ‚¬μ©

# 3. μ‚¬μ© μ™„λ£ ν›„ ν‚¤ λ°λ‚©
curl -X POST http://220.121.120.83/vpn_api/release \
  -H "Content-Type: application/json" \
  -d '{"public_key": "YOUR_PUBLIC_KEY"}'
```

μμ„Έν• λ‚΄μ©: [CLIENT_API.md](CLIENT_API.md)

---

### μ„λ²„ κ΄€λ¦¬μ (μ‹ κ· μ„λ²„ λ“±λ΅)

```bash
# VPN μ„λ²„μ—μ„ μ‹¤ν–‰ (μλ™ λ“±λ΅)
curl -s http://220.121.120.83/vpn_api/one_line_register.sh | bash
```

μμ„Έν• λ‚΄μ©: [SERVER_ADMIN.md](SERVER_ADMIN.md)

---

## μ£Όμ” κΈ°λ¥

### 1. μλ™ ν‚¤ ν• λ‹Ή
- ν΄λΌμ΄μ–ΈνΈ μ”μ²­ μ‹ μ‚¬μ© κ°€λ¥ν• ν‚¤ μλ™ ν• λ‹Ή
- LRU (Least Recently Used) μ „λµμΌλ΅ κ³µν‰ν• λ¶„λ°°
- νΈλμ­μ… κΈ°λ° λ™μ‹μ„± μ μ–΄

### 2. λ‹¤μ¤‘ μ„λ²„ μ§€μ›
- μ—¬λ¬ VPN μ„λ²„μ ν‚¤λ¥Ό μ¤‘μ•™μ—μ„ κ΄€λ¦¬
- μ„λ²„λ³„ λλ” μ „μ²΄ μ„λ²„μ—μ„ μλ™ ν• λ‹Ή
- μ„λ²„λ³„ λ…λ¦½μ μΈ ν‚¤ ν’€ κ΄€λ¦¬

### 3. μ‚¬μ© μ¶”μ 
- ν΄λΌμ΄μ–ΈνΈ IP μλ™ κ°μ§€ (ν”„λ΅μ‹ ν™κ²½ μ§€μ›)
- λ¨λ“  ν• λ‹Ή/λ°λ‚© μ‘μ—… λ΅κ·Έ κΈ°λ΅
- μ‚¬μ© ν†µκ³„ λ° ν™μ„± μ—°κ²° λ¨λ‹ν„°λ§

### 4. μλ™ μ •λ¦¬
- μ¤λλ μ—°κ²° μλ™ λ°λ‚© (κΈ°λ³Έ 10λ¶„)
- ν‚¤ μ¬μ‚¬μ© μµμ ν™”
- μ„λ²„ μ¬μ„¤μΉ μ‹ μ™„μ „ μ‚­μ  μ§€μ›

---

## API μ—”λ“ν¬μΈνΈ

### ν΄λΌμ΄μ–ΈνΈμ©

| μ—”λ“ν¬μΈνΈ | λ©”μ„λ“ | μ„¤λ… |
|-----------|--------|------|
| `/list` | GET | μ‚¬μ© κ°€λ¥ν• VPN μ„λ²„ λ©λ΅ |
| `/allocate` | GET | VPN ν‚¤ ν• λ‹Ή |
| `/release` | POST | VPN ν‚¤ λ°λ‚© |
| `/status` | GET | μ„λ²„ μƒνƒ μ΅°ν |

### κ΄€λ¦¬μμ©

| μ—”λ“ν¬μΈνΈ | λ©”μ„λ“ | μ„¤λ… |
|-----------|--------|------|
| `/server/register` | POST | VPN μ„λ²„ λ“±λ΅ |
| `/keys/register` | POST | ν‚¤ μΌκ΄„ λ“±λ΅ |
| `/release/all` | GET | λ¨λ“  ν‚¤ λ°λ‚© |
| `/release/all?delete=true` | GET | μ„λ²„ μ™„μ „ μ‚­μ  |
| `/cleanup` | POST | μ¤λλ μ—°κ²° μ •λ¦¬ |

μ „μ²΄ API λ¬Έμ„: [CLIENT_API.md](CLIENT_API.md) | [SERVER_ADMIN.md](SERVER_ADMIN.md)

---

## λ°μ΄ν„°λ² μ΄μ¤ κµ¬μ΅°

### vpn_servers
VPN μ„λ²„ μ •λ³΄ (IP, ν¬νΈ, κ³µκ°ν‚¤, ν‚¤ μΉ΄μ΄νΈ)
- `total_keys`: μ„λ²„μ— λ“±λ΅λ μ΄ ν‚¤ κ°μ
- `available_keys`: μ‚¬μ© κ°€λ¥ν• ν‚¤ κ°μ
- λ°μ΄ν„°λ² μ΄μ¤ νΈλ¦¬κ±°λ΅ μλ™ μ—…λ°μ΄νΈ

### vpn_keys
ν΄λΌμ΄μ–ΈνΈ ν‚¤ μ •λ³΄ (λ‚΄λ¶€ IP, ν‚¤ μ, μ‚¬μ© μƒνƒ)

### vpn_usage_logs
μ‚¬μ© κΈ°λ΅ (ν• λ‹Ή/λ°λ‚© μ‹κ°, ν΄λΌμ΄μ–ΈνΈ IP, μ—°κ²° μ‹κ°„)

**κ΄€κ³„**: `vpn_servers` β†’ `vpn_keys` β†’ `vpn_usage_logs` (CASCADE DELETE)

**μλ™ν™”**: ν‚¤ μ¶”κ°€/μ‚­μ /μƒνƒ λ³€κ²½ μ‹ λ°μ΄ν„°λ² μ΄μ¤ νΈλ¦¬κ±°κ°€ μ„λ²„ ν†µκ³„λ¥Ό μλ™μΌλ΅ μ—…λ°μ΄νΈ

---

## μ‹μ¤ν… μ”κµ¬μ‚¬ν•­

### VPN μ„λ²„ (WireGuard)
- WireGuard μ„¤μΉ
- 10κ° ν΄λΌμ΄μ–ΈνΈ ν‚¤ μ‚¬μ „ μƒμ„± (10.8.0.10 ~ 10.8.0.19)
- curl, jq ν¨ν‚¤μ§€

### API μ„λ²„
- Apache 2.4+
- PHP 8.0+
- MariaDB/MySQL 5.7+
- PDO extension

---

## μ„¤μΉ λ° μ„¤μ •

### λ°μ΄ν„°λ² μ΄μ¤ μ΄κΈ°ν™”

```bash
mysql -u vpnuser -p vpn < schema.sql
```

### Apache μ„¤μ •

`.htaccess` νμΌμ΄ URL λΌμ°ν…μ„ μλ™μΌλ΅ μ²λ¦¬ν•©λ‹λ‹¤.

```apache
RewriteEngine On
RewriteBase /vpn_api/
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]
```

---

## ν…μ¤νΈ

```bash
# API μ„λ²„ μƒνƒ
curl http://220.121.120.83/vpn_api/health

# λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²°
curl http://220.121.120.83/vpn_api/test/db

# μ„λ²„ λ©λ΅
curl http://220.121.120.83/vpn_api/list
```

---

## ν”„λ΅μ νΈ κµ¬μ΅°

```
/var/www/html/vpn_api/
β”β”€β”€ index.php              # API μ—”νΈλ¦¬ ν¬μΈνΈ λ° λΌμ°ν…
β”β”€β”€ .htaccess             # Apache URL λ¦¬λΌμ΄νΈ κ·μΉ™
β”β”€β”€ config/
β”‚   β””β”€β”€ database.php      # λ°μ΄ν„°λ² μ΄μ¤ μ—°κ²°
β”β”€β”€ api/
β”‚   β””β”€β”€ vpn.php          # VpnApi ν΄λμ¤ (λΉ„μ¦λ‹μ¤ λ΅μ§)
β”β”€β”€ utils/
β”‚   β””β”€β”€ wireguard.php    # WireGuard μ ν‹Έλ¦¬ν‹°
β”β”€β”€ schema.sql           # λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§
β”β”€β”€ *.sh                 # μ„λ²„ λ“±λ΅ μλ™ν™” μ¤ν¬λ¦½νΈ
β”β”€β”€ CLIENT_API.md        # ν΄λΌμ΄μ–ΈνΈ μ‚¬μ© κ°€μ΄λ“
β”β”€β”€ SERVER_ADMIN.md      # μ„λ²„ κ΄€λ¦¬μ κ°€μ΄λ“
β””β”€β”€ CLAUDE.md           # κ°λ°μ κΈ°μ  λ¬Έμ„
```

---

## λ³΄μ•

### ν„μ¬ κµ¬ν„
- ν΄λΌμ΄μ–ΈνΈ IP κΈ°λ° μ¶”μ 
- λ°μ΄ν„°λ² μ΄μ¤ νΈλμ­μ…μΌλ΅ λ™μ‹μ„± μ μ–΄
- Prepared statementsλ΅ SQL injection λ°©μ§€

### κ¶μ¥ μ‚¬ν•­
- API μΈμ¦ μ¶”κ°€ (API Key, JWT λ“±)
- HTTPS μ‚¬μ©
- λ°©ν™”λ²½μΌλ΅ API μ ‘κ·Ό μ ν•
- λ΅κ·Έ μ •κΈ° λ¨λ‹ν„°λ§

---

## λΌμ΄μ„ μ¤

μ΄ ν”„λ΅μ νΈλ” λ‚΄λ¶€ μ‚¬μ©μ„ μ„ν• κ²ƒμ…λ‹λ‹¤.

---

## μ§€μ›

- **λ²„κ·Έ λ¦¬ν¬νΈ**: μ‹μ¤ν… κ΄€λ¦¬μμ—κ² λ¬Έμ
- **κΈ°λ¥ μ”μ²­**: GitHub Issues (λ‚΄λ¶€)
- **κΈ΄κΈ‰ μ§€μ›**: 24/7 on-call λ‹΄λ‹Ήμ

---

## λ³€κ²½ μ΄λ ¥

### v1.1.0 (2025-11-07)
- β¨ `/status` μ—”λ“ν¬μΈνΈμ— `server_list` μ¶”κ°€ (μ„λ²„λ³„ ν‚¤ μ‚¬μ© ν„ν™©)
- β¨ λ°μ΄ν„°λ² μ΄μ¤ νΈλ¦¬κ±°λ΅ μ„λ²„ ν†µκ³„ μλ™ μ—…λ°μ΄νΈ (`total_keys`, `available_keys`)
- π”§ μ„λ²„ λ©λ΅ ν•„ν„°λ§ μ΅°κ±΄ κ°μ„  (server_pubkey μ΅΄μ¬ λ° is_active ν™•μΈ)

### v1.0.0 (2025-11-05)
- β¨ μ΄κΈ° λ¦΄λ¦¬μ¤
- β¨ VPN ν‚¤ μλ™ ν• λ‹Ή/λ°λ‚©
- β¨ λ‹¤μ¤‘ μ„λ²„ μ§€μ›
- β¨ μ‚¬μ© λ΅κ·Έ λ° ν†µκ³„
- β¨ μ„λ²„ μ™„μ „ μ‚­μ  κΈ°λ¥
